var app=app||{};app.map=function(){var e=960,t=600,n="60000",r="1",i,s,o,u,a,f,l;return o=d3.geo.albers().rotate([0,0]).center([7.3,47]).scale(13600),u=d3.geo.path().projection(o),a=d3.select("#map").append("svg").attr("width",e).attr("height",t).call(d3.behavior.zoom().on("zoom",function(){a.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")})).append("g"),f=d3.scale.linear().range([0,1]),l=function(){return l},l.load=function(){d3.json("assets/geodata/topojson/swiss-municipalities-simplified.json",l.draw),d3.csv("assets/data/fichier.csv",l.ready)},l.ready=function(e,t){function a(e){var t=s[e];$("#income_value").text("CHF "+t),n=t,l.render()}var s,o,u;i=d3.nest().key(function(e){return e.gross_income}).key(function(e){return e.social_group}).key(function(e){return e.bfs_number}).rollup(function(e){return e[0]}).map(t),s=d3.keys(i),o=d3.extent(t,function(e){return parseInt(e.timespan,10)}),f.domain(o),$("#income_slider").slider({orientation:"horizontal",max:s.length-1,value:4,step:1,slide:function(e,t){a(t.value)}}),a($("#income_slider").slider("value")),$('input[name="demographics"]').on("change",function(){r=$(this).val(),l.render()}),$("#loading").hide()},l.draw=function(e){s=topojson.object(e,e.objects["swiss-municipalities"]).geometries,a.selectAll("path").data(s).enter().append("path").attr("class","municipality").attr("data-bfsno",function(e){return e.properties.bfsNo}).style("fill",function(e){return"rgb(255, 255, 255)"}).attr("d",u).append("title").text(function(e){return e.properties.name})},l.render=function(){var e,t;e=d3.map(i[n][r]),t=d3.extent(e.values(),function(e){return parseInt(e.timespan,10)}),f.domain(t),d3.selectAll("path").style("fill",function(t){var n,r;return n=t.properties.bfsNo,e.has(n)?(r=f(parseInt(e.get(n).timespan,10)),"rgba(49,163,84,"+r+")"):"rgb(214,234,247)"})},l};